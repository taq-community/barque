---
title: "Comparison of eDNA Read Counts Between IBIS and Steve Pipelines"
author: "Generated from R script"
format: 
  html:
    self-contained: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(readxl)
library(janitor)
library(tidyr)
library(stringr)
```

## Load and Clean Data

```{r}
res_steve <- read.csv("12_results/12s200pb_species_table.csv") |> 
  dplyr::filter(dplyr::row_number() <= dplyr::n() - 1)

res_ibis <- readxl::read_excel(
  "/home/steve/Documents/INRS/Data/reproStudy/final_2024102510000077_12S_ValerieLanglois0.0001.xlsx", 
  sheet = "Poissons"
) |> 
  dplyr::filter(dplyr::row_number() <= dplyr::n()-1) |> 
  dplyr::bind_rows(
    readxl::read_excel(
      "/home/steve/Documents/INRS/Data/reproStudy/final_2024102510000077_12S_ValerieLanglois0.0001.xlsx", 
      sheet = "Autres espèces"
    ) |> 
    dplyr::filter(dplyr::row_number() <= dplyr::n()-1)
  )

res_steve <- janitor::clean_names(res_steve)
res_ibis <- janitor::clean_names(res_ibis)

res_ibis <- res_ibis |> 
  dplyr::mutate(taxon_name = stringr::str_replace_all(
    paste(groupe, nom_scientifique), " ", "_"
  )) |> 
  dplyr::select(taxon_name, tidyr::starts_with("langlois_12s"))

res_steve <- res_steve |> 
  dplyr::select(taxon_name, tidyr::starts_with("langlois_12s"))
```

## Merge and Reshape Data

We transform the data to be in long format: Sample on rows instead of columns

```{r}
res_long <- res_steve |> 
  tidyr::pivot_longer(
    cols = tidyr::starts_with("langlois_12s"),
    names_to = "sample",
    values_to = "n_reads"
  ) |> 
  dplyr::mutate(src = "steve") |> 
  dplyr::bind_rows(
    res_ibis |> 
      tidyr::pivot_longer(
        cols = tidyr::starts_with("langlois_12s"),
        names_to = "sample",
        values_to = "n_reads"
      ) |> 
      dplyr::mutate(src = "ibis")
  )
```

## Read Count Differences per Sample

```{r}
diff_n_reads <- res_long |> 
  dplyr::group_by(src, sample) |> 
  dplyr::summarise(n_reads = sum(n_reads, na.rm = TRUE)) |> 
  tidyr::pivot_wider(
    names_from = src,
    values_from = n_reads,
    values_fill = NA
  ) |> 
  dplyr::mutate(diff_reads = ibis - steve)

hist(diff_n_reads$diff_reads)

diff_n_reads <- diff_n_reads |> 
  dplyr::mutate(diff_reads_pct = (diff_reads / ibis) * 100)

summary(diff_n_reads$diff_reads_pct)
```

Le nombre de reads par échantillon est identique entre mon analyse et celle de IBIS. Le nombre de reads varie entre 1% et 2%.

## Species-Level Comparison

```{r}
diff_n_read_by_sp <- res_long |> 
  dplyr::group_by(taxon_name, src) |> 
  dplyr::summarise(n_reads = sum(n_reads, na.rm = TRUE)) |> 
  tidyr::pivot_wider(
    names_from = src,
    values_from = n_reads,
    values_fill = NA
  ) |> 
  dplyr::mutate(diff_reads = ibis - steve)

diff_1000_reads <- diff_n_read_by_sp |> 
  dplyr::filter(diff_reads > 500)

diff_1000_reads$taxon_name

diff_n_read_by_sp |> 
  dplyr::filter(stringr::str_detect(taxon_name, "Salvelinus"))
```

### Which species has been missing?

Le tableau ci-dessous montre les espèces absentes entre les deux analyses.

Problème 1 - Manque le groupe à l'espèce\
Problème 2 - Gestion des multihits

```{r}
diff_n_read_by_sp |> 
  dplyr::filter(is.na(diff_reads)) |> reactable::reactable(defaultPageSize = 50)
```
